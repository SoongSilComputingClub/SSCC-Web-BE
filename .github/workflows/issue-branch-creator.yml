name: Issue Branch Creator

on:
  issues:
    types: [opened]

jobs:
  create_branch:
    runs-on: ubuntu-latest
    if: github.event.issue.user.login != 'github-actions[bot]'

    services:
      libretranslate:
        image: libretranslate/libretranslate:latest
        ports:
          - 5000:5000
        env:
          LT_LOAD_ONLY: ko,en

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Wait for LibreTranslate to be ready
        run: |
          echo "LibreTranslate ëª¨ë¸ ë¡œë”© ëŒ€ê¸° ì¤‘..."
          for i in $(seq 1 60); do
            if curl -sf http://localhost:5000/languages > /dev/null 2>&1; then
              echo "LibreTranslate ì¤€ë¹„ ì™„ë£Œ"
              exit 0
            fi
            sleep 5
          done
          echo "::warning::LibreTranslate ì‹œì‘ ì‹œê°„ ì´ˆê³¼ â€” ë²ˆì—­ ì—†ì´ ì§„í–‰í•©ë‹ˆë‹¤"

      - name: Parse title and determine prefix
        id: parse
        run: |
          TITLE="${{ github.event.issue.title }}"

          # ì´ìŠˆ ì œëª©ì—ì„œ [Feat], [Bug] ë“± ì ‘ë‘ì‚¬ ì¶”ì¶œ â†’ ë¸Œëœì¹˜ prefix ê²°ì •
          TAG=$(echo "$TITLE" | grep -oE '^\[[A-Za-z]+\]' | tr -d '[]' | tr '[:upper:]' '[:lower:]')

          case "$TAG" in
            feat)     PREFIX="feat" ;;
            bug|fix)  PREFIX="fix" ;;
            refactor) PREFIX="refactor" ;;
            docs)     PREFIX="docs" ;;
            chore)    PREFIX="chore" ;;
            test)     PREFIX="test" ;;
            *)        PREFIX="feat" ;;
          esac

          # ì ‘ë‘ì‚¬ íƒœê·¸ ì œê±° (ì˜ˆ: [Feat] ì§€ì› ê¸°ê°„ì— ë”°ë¥¸... â†’ ì§€ì› ê¸°ê°„ì— ë”°ë¥¸...)
          CLEAN_TITLE=$(echo "$TITLE" | sed 's/\[[^]]*\]//g' | xargs)

          echo "prefix=$PREFIX" >> "$GITHUB_OUTPUT"
          echo "clean_title=$CLEAN_TITLE" >> "$GITHUB_OUTPUT"

      - name: Translate title to English
        id: translate
        run: |
          CLEAN_TITLE="${{ steps.parse.outputs.clean_title }}"

          # í•œê¸€ í¬í•¨ ì—¬ë¶€ í™•ì¸
          if echo "$CLEAN_TITLE" | grep -qP '[\x{AC00}-\x{D7AF}]'; then
            echo "í•œê¸€ ê°ì§€ â€” LibreTranslateë¡œ ë²ˆì—­ ì‹œë„"

            TRANSLATED=$(curl -sf -X POST http://localhost:5000/translate \
              -H "Content-Type: application/json" \
              -d "{\"q\": \"$CLEAN_TITLE\", \"source\": \"ko\", \"target\": \"en\"}" \
              | jq -r '.translatedText // empty')

            if [ -n "$TRANSLATED" ]; then
              echo "ë²ˆì—­ ê²°ê³¼: $TRANSLATED"
              echo "text=$TRANSLATED" >> "$GITHUB_OUTPUT"
            else
              echo "::warning::ë²ˆì—­ ì‹¤íŒ¨ â€” ì›ë³¸ ì œëª©ì„ ì‚¬ìš©í•©ë‹ˆë‹¤"
              echo "text=$CLEAN_TITLE" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "ì˜ë¬¸ ì œëª© â€” ë²ˆì—­ ë¶ˆí•„ìš”"
            echo "text=$CLEAN_TITLE" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push branch
        run: |
          PREFIX="${{ steps.parse.outputs.prefix }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          TEXT="${{ steps.translate.outputs.text }}"

          # 1. ìŠ¬ëŸ¬ê·¸ ì •ì œ: ì†Œë¬¸ì, ì˜ë¬¸/ìˆ«ì/í•˜ì´í”ˆë§Œ, ê³µë°±â†’í•˜ì´í”ˆ
          SLUG=$(echo "$TEXT" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9 -]//g' | sed 's/ /-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          # 2. ìµœëŒ€ 50ìë¡œ ì œí•œ
          SLUG=$(echo "$SLUG" | cut -c1-50 | sed 's/-$//')

          # 3. ë¸Œëœì¹˜ëª… ì¡°í•©
          if [ -n "$SLUG" ]; then
            BRANCH_NAME="${PREFIX}/#${ISSUE_NUMBER}-${SLUG}"
          else
            BRANCH_NAME="${PREFIX}/#${ISSUE_NUMBER}"
          fi

          # 4. Git ì„¤ì • ë° í‘¸ì‹œ
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

          # 5. ì´ìŠˆì— ë¸Œëœì¹˜ ì •ë³´ ì½”ë©˜íŠ¸
          gh issue comment "$ISSUE_NUMBER" --body "ğŸŒ¿ ë¸Œëœì¹˜ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: \`$BRANCH_NAME\`"
        env:
          GITHUB_TOKEN: ${{ github.token }}
