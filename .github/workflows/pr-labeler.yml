name: PR Labeler

on:
  pull_request:
    types: [opened, synchronize, edited]

jobs:
  # ==========================================================================
  # Size Label - PR í¬ê¸°ì— ë”°ë¥¸ ë¼ë²¨ (ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸)
  # ==========================================================================
  size-label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Label PR by Size
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const totalChanges = pr.additions + pr.deletions;

            console.log(`ğŸ“Š PR #${prNumber} ë³€ê²½: +${pr.additions} -${pr.deletions} (ì´ ${totalChanges} lines)`);

            const sizeLabels = {
              'size/XS': { max: 10, color: '3CBF00' },
              'size/S': { max: 50, color: '5D9801' },
              'size/M': { max: 200, color: 'FBCA04' },
              'size/L': { max: 500, color: 'FFA500' },
              'size/XL': { max: Infinity, color: 'D93F0B' }
            };

            let newSizeLabel = 'size/XL';
            for (const [label, config] of Object.entries(sizeLabels)) {
              if (totalChanges <= config.max) {
                newSizeLabel = label;
                break;
              }
            }

            // í˜„ì¬ ë¼ë²¨ í™•ì¸
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const currentSizeLabel = currentLabels.find(l => l.name.startsWith('size/'));

            // ê°™ì€ ë¼ë²¨ì´ë©´ ìŠ¤í‚µ
            if (currentSizeLabel?.name === newSizeLabel) {
              console.log(`âœ… ì´ë¯¸ ì˜¬ë°”ë¥¸ í¬ê¸° ë¼ë²¨: ${newSizeLabel}`);
              return;
            }

            // ê¸°ì¡´ size ë¼ë²¨ ì œê±°
            if (currentSizeLabel) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: currentSizeLabel.name
              });
            }

            // ë¼ë²¨ì´ ì—†ìœ¼ë©´ ìƒì„±
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: newSizeLabel
              });
            } catch (error) {
              if (error.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: newSizeLabel,
                  color: sizeLabels[newSizeLabel].color,
                  description: `PR size: ${newSizeLabel.replace('size/', '')}`
                });
              }
            }

            // ìƒˆ ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [newSizeLabel]
            });

            console.log(`âœ… í¬ê¸° ë¼ë²¨ ì ìš©: ${newSizeLabel}`);

  # ==========================================================================
  # Type Label - PR ì»¤ë°‹ë“¤ì—ì„œ íƒ€ì… ì¶”ì¶œ (ì—†ì„ ë•Œë§Œ ì¶”ê°€)
  # ==========================================================================
  type-label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Label PR by Commit Types
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // ì§€ì›í•˜ëŠ” íƒ€ì… ë¼ë²¨ ì •ì˜
            const typeLabels = {
              'Feat':     { color: '0E8A16', description: 'ìƒˆë¡œìš´ ê¸°ëŠ¥' },
              'Fix':      { color: 'D93F0B', description: 'ë²„ê·¸ ìˆ˜ì •' },
              'Refactor': { color: '1D76DB', description: 'ë¦¬íŒ©í† ë§' },
              'Design':   { color: 'F9D0C4', description: 'UI/ë””ìì¸ ë³€ê²½' },
              'Style':    { color: 'FEF2C0', description: 'ì½”ë“œ ìŠ¤íƒ€ì¼ ë³€ê²½' },
              'Docs':     { color: '0075CA', description: 'ë¬¸ì„œ ìˆ˜ì •' },
              'Test':     { color: 'BFD4F2', description: 'í…ŒìŠ¤íŠ¸ ì½”ë“œ' },
              'Chore':    { color: 'D4C5F9', description: 'ê¸°íƒ€ ë³€ê²½ì‚¬í•­' },
              'Init':     { color: '5319E7', description: 'ì´ˆê¸° ìƒì„±' },
              'Rename':   { color: 'C2E0C6', description: 'íŒŒì¼/í´ë”ëª… ë³€ê²½' },
              'Remove':   { color: 'B60205', description: 'íŒŒì¼ ì‚­ì œ' },
              'Cicd':     { color: 'FBCA04', description: 'CI/CD ê´€ë ¨' }
            };

            const typeKeys = Object.keys(typeLabels);
            const typePattern = new RegExp(`(?:^|\\s)(${typeKeys.join('|')})(?:\\([^)]*\\))?:`, 'i');

            // PRì˜ ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            console.log(`ğŸ“ PR #${prNumber} ì»¤ë°‹ ìˆ˜: ${commits.length}`);

            // ê° ì»¤ë°‹ì—ì„œ íƒ€ì… ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
            const detectedTypes = new Set();
            for (const commit of commits) {
              const message = commit.commit.message.split('\n')[0]; // ì²« ì¤„ë§Œ
              const match = message.match(typePattern);
              if (match) {
                detectedTypes.add(match[1].toLowerCase());
              }
              console.log(`   - ${message.substring(0, 60)}${message.length > 60 ? '...' : ''}`);
            }

            console.log(`ğŸ” ê°ì§€ëœ íƒ€ì…: ${[...detectedTypes].join(', ') || 'ì—†ìŒ'}`);

            if (detectedTypes.size === 0) {
              console.log('âš ï¸ ì»¤ë°‹ì—ì„œ íƒ€ì…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }

            // í˜„ì¬ ë¼ë²¨ í™•ì¸
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const currentLabelNames = currentLabels.map(l => l.name);

            // ì¶”ê°€í•  íƒ€ì… ë¼ë²¨ í•„í„°ë§ (ì´ë¯¸ ìˆëŠ” ê²ƒ ì œì™¸)
            const labelsToAdd = [...detectedTypes].filter(type => !currentLabelNames.includes(type));

            if (labelsToAdd.length === 0) {
              console.log('âœ… ëª¨ë“  íƒ€ì… ë¼ë²¨ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
              return;
            }

            // ë¼ë²¨ì´ ì—†ìœ¼ë©´ ìƒì„±
            for (const type of labelsToAdd) {
              const labelConfig = typeLabels[type];
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: type
                });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: type,
                    color: labelConfig.color,
                    description: labelConfig.description
                  });
                }
              }
            }

            // íƒ€ì… ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: labelsToAdd
            });

            console.log(`âœ… íƒ€ì… ë¼ë²¨ ì¶”ê°€: ${labelsToAdd.join(', ')}`);
